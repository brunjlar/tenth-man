<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenth Man</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style for the share button icon */
        .share-icon {
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
        }

        /* Styles for the Floating Navigation buttons */
        #nav-button-group {
            transition: opacity 0.3s, transform 0.3s;
        }

        .nav-btn {
            background-color: #2563eb;
            /* bg-blue-600 */
            color: white;
            padding: 0.75rem;
            /* p-3 */
            border-radius: 9999px;
            /* rounded-full */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            /* shadow-lg */
        }

        .nav-btn:hover {
            background-color: #1d4ed8;
            /* hover:bg-blue-700 */
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #4b5563;
            /* bg-gray-600 */
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100">

    <div id="app" class="container mx-auto p-4 md:p-8 flex flex-col min-h-screen">

        <main class="flex-grow">
            <div id="header-section">
                <header class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Iterative AI Refinement</h1>
                    <p class="text-lg text-gray-400">Using a "Tenth Man" critique to improve AI responses.</p>
                </header>

                <!-- Configuration Section -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- API Key Input -->
                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-2">API Key (Saved in
                                Browser)</label>
                            <input id="apiKey" type="password" placeholder="Enter your Google AI API Key"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition" />
                        </div>
                        <!-- Placeholder for alignment -->
                        <div></div>
                    </div>
                    <!-- Prompt Input -->
                    <div class="mt-6 relative">
                        <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">Your Prompt</label>
                        <textarea id="prompt" rows="3" placeholder="e.g., Explain the benefits of a four-day work week."
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition"></textarea>
                        <button id="share-prompt-btn"
                            class="absolute top-10 right-3 text-gray-400 hover:text-white transition"
                            title="Copy or Share Prompt">
                            <svg class="share-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Action Button -->
                    <div class="mt-6 text-center">
                        <button id="generate-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:scale-100">
                            Start Refinement
                        </button>
                    </div>
                </div>
                <!-- Status Display Area -->
                <div id="status-container" class="pb-4"></div>
            </div>

            <!-- Results Section -->
            <div id="results-container" class="space-y-8"></div>
        </main>

        <!-- Footer Section -->
        <footer class="text-center py-6 text-gray-500 text-sm">
            <button id="about-btn" class="hover:text-white transition underline mb-2">About This App</button>
            <p>
                Created by <a href="mailto:brunjlar@gmail.com" class="hover:text-white transition underline">Lars
                    Br√ºnjes</a> |
                <a href="https://github.com/brunjlar/tenth-man" target="_blank" rel="noopener noreferrer"
                    class="hover:text-white transition underline">GitHub</a>
            </p>
        </footer>
    </div>

    <!-- About Modal -->
    <div id="about-modal"
        class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4 transition-opacity">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 md:p-8 max-w-2xl w-full text-gray-300 border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">The Tenth Man Principle</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="space-y-4 prose prose-invert max-w-none">
                <p>This application uses an iterative AI process to generate, critique, and refine text-based responses,
                    based on the 'Tenth Man' principle.</p>
                <p>This rule originated with the Israeli intelligence community (Mossad) following the strategic
                    surprise of the 1973 Yom Kippur War. To prevent future failures of imagination and avoid the trap of
                    groupthink, a new protocol was established: if a group of ten analysts comes to a unanimous
                    conclusion, a tenth person is designated to challenge that consensus, no matter how unlikely their
                    dissenting argument may seem.</p>
                <p>This forces the group to re-examine their assumptions from the ground up and strengthens the final
                    conclusion. The concept has been popularized in media, notably in the movie <em>World War Z</em>.
                </p>
                <p>In this app, one AI instance generates a response, and a second 'Tenth Man' AI is specifically
                    prompted to find flaws and offer a contrarian critique. This cycle can be repeated multiple times,
                    with each iteration synthesizing the previous response and critique into a more robust and
                    well-considered final answer.</p>
            </div>
            <div class="text-right mt-6">
                <button id="close-modal-btn-2"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Navigation Button Group -->
    <div id="nav-button-group"
        class="fixed bottom-8 right-8 z-40 flex flex-col items-center space-y-2 opacity-0 transform translate-y-4 pointer-events-none">
        <button id="prev-result-btn" class="nav-btn" title="Previous Result">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
            </svg>
        </button>
        <button id="back-to-top-btn" class="nav-btn" title="Back to Top">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </button>
        <button id="next-result-btn" class="nav-btn" title="Next Result">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
    </div>


    <script type="module">
        // --- DOM Element References ---
        const apiKeyInput = document.getElementById('apiKey');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate-btn');
        const resultsContainer = document.getElementById('results-container');
        const statusContainer = document.getElementById('status-container');
        const sharePromptBtn = document.getElementById('share-prompt-btn');
        const aboutBtn = document.getElementById('about-btn');
        const aboutModal = document.getElementById('about-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const closeModalBtn2 = document.getElementById('close-modal-btn-2');
        const navButtonGroup = document.getElementById('nav-button-group');
        const prevResultBtn = document.getElementById('prev-result-btn');
        const backToTopBtn = document.getElementById('back-to-top-btn');
        const nextResultBtn = document.getElementById('next-result-btn');

        // --- STATE MANAGEMENT ---
        let state = {
            apiKey: '',
            prompt: '',
            results: [],
            isLoading: false,
            error: null,
            statusMessage: '',
        };
        let intersectionObserver;
        let currentVisibleIndex = -1;

        // --- RENDER FUNCTION ---
        function render() {
            apiKeyInput.value = state.apiKey;
            promptInput.value = state.prompt;

            generateBtn.disabled = state.isLoading;
            if (state.isLoading) {
                generateBtn.textContent = 'Generating...';
            } else if (state.results.length > 0) {
                generateBtn.textContent = 'Refine Further';
            } else {
                generateBtn.textContent = 'Start Refinement';
            }

            statusContainer.innerHTML = '';
            if (state.error) {
                statusContainer.innerHTML = `<div class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg text-center">${state.error}</div>`;
            } else if (state.isLoading && state.statusMessage) {
                statusContainer.innerHTML = `<div class="bg-blue-500/20 border border-blue-500 text-blue-300 px-4 py-3 rounded-lg text-center animate-pulse">${state.statusMessage}</div>`;
            }

            resultsContainer.innerHTML = state.results.map((result, index) => `
                <div class="result-item bg-gray-800/50 p-4 md:p-6 rounded-2xl shadow-lg border border-gray-700" data-index="${index}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column: Response / Refinement -->
                        <div class="bg-gray-800 p-4 rounded-lg relative">
                             <button class="share-btn absolute top-3 right-3 text-gray-400 hover:text-white transition" data-content-type="response" data-index="${index}" title="Copy or Share">
                                <svg class="share-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                            </button>
                            <h3 class="text-xl font-semibold text-white mb-3 pr-8">
                                ${index === 0 ? 'Initial Response' : `Refinement ${index}`}
                            </h3>
                            <div class="text-gray-300 whitespace-pre-wrap">${result.response}</div>
                        </div>
                        <!-- Right Column: Critique -->
                        <div class="bg-gray-800 p-4 rounded-lg relative">
                             <button class="share-btn absolute top-3 right-3 text-gray-400 hover:text-white transition" data-content-type="critique" data-index="${index}" title="Copy or Share">
                                <svg class="share-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                            </button>
                            <h3 class="text-xl font-semibold text-white mb-3 pr-8">
                                Critique ${index + 1}
                            </h3>
                            <div class="text-gray-300 whitespace-pre-wrap">${result.critique || "Awaiting critique..."}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            setupNavigationObserver();
        }

        // --- API HELPER ---
        async function callGeminiApi(userPrompt, apiKey, systemInstruction = null) {
            console.groupCollapsed(`API Call | System: ${systemInstruction ? systemInstruction.substring(0, 20) : 'None'}...`);
            console.log("System Instruction:", systemInstruction);
            console.log("User Prompt:", userPrompt);

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: userPrompt }] }],
                generationConfig: { temperature: 0.7, topK: 1, topP: 1, maxOutputTokens: 65536 },
            };

            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API HTTP Error:", response.status, errorData);
                    throw new Error(`API Error: ${errorData.error.message} (Status: ${response.status})`);
                }

                const result = await response.json();
                console.log("Full API Response:", result);

                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;

                if (text && text.trim() !== '') {
                    console.log("Response Text:", text);
                    console.groupEnd();
                    return text;
                } else {
                    const finishReason = candidate?.finishReason;
                    console.error(`API call finished with reason: ${finishReason}`);
                    let errorMessage = "API returned an empty or invalid response.";
                    if (finishReason === 'SAFETY') {
                        errorMessage = "Response was blocked for safety reasons. Please adjust your prompt.";
                    } else if (finishReason === 'MAX_TOKENS') {
                        errorMessage = "Response was stopped because it reached the maximum length.";
                    } else if (finishReason) {
                        errorMessage = `An issue occurred. (Finish Reason: ${finishReason})`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error("callGeminiApi Failed:", error);
                console.groupEnd();
                throw error;
            }
        }

        // --- EVENT HANDLERS & LOGIC ---
        async function handleGenerate() {
            if (!state.prompt) {
                updateState({ error: "Please enter a prompt." });
                return;
            }
            if (!state.apiKey) {
                updateState({ error: "Please enter your API key." });
                return;
            }

            updateState({ isLoading: true, error: null });

            const expertSystemInstruction = 'You are an expert assistant. Your goal is to provide a detailed and well-structured response.';
            const tenthManSystemInstruction = 'You are the "Tenth Man," a contrarian thinker tasked with finding flaws, hidden assumptions, and alternative perspectives. Your goal is to strengthen the original argument by challenging it. Be direct, insightful, and constructive. Do not agree with the text. Your critique should be actionable.';
            const synthesizerSystemInstruction = 'You are a synthesizer and refiner. Your task is to integrate an original response with its critique to create a new, improved version. The new version should address the weaknesses and incorporate the valid points from the critique, resulting in a more robust and comprehensive answer.';

            try {
                if (state.results.length === 0) {
                    // --- Initial Run ---
                    console.clear();
                    console.group("--- Starting New Refinement Process ---");
                    updateState({ statusMessage: 'Generating Initial Response...' });
                    const initialUserPrompt = `Respond to the following prompt: "${state.prompt}"`;
                    const initialResponse = await callGeminiApi(initialUserPrompt, state.apiKey, expertSystemInstruction);

                    let currentResults = [{ id: 0, response: initialResponse, critique: '' }];
                    updateState({ results: currentResults, statusMessage: 'Generating Critique...' });

                    const critiqueUserPrompt = `The user's original request was: "${state.prompt}"\n\nCritically analyze the following text which was generated in response to that request:\n---\n${initialResponse}`;
                    const critique = await callGeminiApi(critiqueUserPrompt, state.apiKey, tenthManSystemInstruction);

                    currentResults[0].critique = critique;
                    updateState({ results: [...currentResults] });

                } else {
                    // --- Refinement Run ---
                    console.group(`--- Starting Refinement Iteration ${state.results.length} ---`);
                    const lastResult = state.results[state.results.length - 1];

                    updateState({ statusMessage: 'Generating Synthesis...' });
                    const synthesisUserPrompt = `Original Response:\n---\n${lastResult.response}\n---\nCritique of the Response:\n---\n${lastResult.critique}\n---\nBased on the critique, provide a new, refined response:`;
                    const synthesis = await callGeminiApi(synthesisUserPrompt, state.apiKey, synthesizerSystemInstruction);

                    let currentResults = [...state.results, { id: state.results.length, response: synthesis, critique: '' }];
                    updateState({ results: currentResults, statusMessage: 'Generating Critique...' });

                    const newCritiqueUserPrompt = `The user's original request was: "${state.prompt}"\n\nCritically analyze the following text which was generated in response to that request:\n---\n${synthesis}`;
                    const newCritique = await callGeminiApi(newCritiqueUserPrompt, state.apiKey, tenthManSystemInstruction);

                    currentResults[currentResults.length - 1].critique = newCritique;
                    updateState({ results: [...currentResults] });
                }
            } catch (err) {
                console.error("Error during generation process:", err);
                updateState({ error: err.message || "An unknown error occurred." });
            } finally {
                updateState({ isLoading: false, statusMessage: '' });
                console.groupEnd();
            }
        }

        // --- REFACTORED SHARE/COPY HANDLER ---
        async function shareText(textToShare, button) {
            if (!textToShare || !button) return;

            if (navigator.share) {
                try {
                    await navigator.share({ text: textToShare });
                    return;
                } catch (err) {
                    console.info("Web Share API cancelled.", err.name !== 'AbortError' ? err : '');
                }
            }

            try {
                const ta = document.createElement('textarea');
                ta.value = textToShare;
                ta.style.position = 'absolute';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);

                const originalIcon = button.innerHTML;
                button.innerHTML = `<svg class="share-icon text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                setTimeout(() => { button.innerHTML = originalIcon; }, 2000);

            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy text.');
            }
        }

        // --- STATE UPDATE HELPER ---
        function updateState(newState) {
            state = { ...state, ...newState };
            render();
        }

        // --- MODAL LOGIC ---
        function showModal() {
            aboutModal.classList.remove('hidden');
            aboutModal.classList.add('flex');
        }
        function hideModal() {
            aboutModal.classList.add('hidden');
            aboutModal.classList.remove('flex');
        }

        // --- **REVISED**: NAVIGATION LOGIC ---
        function setupNavigationObserver() {
            if (intersectionObserver) {
                intersectionObserver.disconnect();
            }
            const sections = document.querySelectorAll('.result-item');
            if (sections.length === 0) {
                currentVisibleIndex = -1;
                return;
            }

            const handleIntersection = (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        currentVisibleIndex = parseInt(entry.target.dataset.index, 10);
                        updateNavButtonsState();
                    }
                });
            };

            // This observer uses a margin to define the "active" area as the center of the viewport.
            // When a result card enters this area, it becomes the current one.
            intersectionObserver = new IntersectionObserver(handleIntersection, {
                root: null,
                rootMargin: "-50% 0px -50% 0px",
                threshold: 0,
            });

            sections.forEach(section => intersectionObserver.observe(section));
        }

        function updateNavButtonsState() {
            const sections = document.querySelectorAll('.result-item');
            if (currentVisibleIndex === -1) {
                // If no section is "active", find the one closest to the top.
                let closestIndex = 0;
                let minTop = Infinity;
                sections.forEach((section, index) => {
                    const top = section.getBoundingClientRect().top;
                    if (top >= 0 && top < minTop) {
                        minTop = top;
                        closestIndex = index;
                    }
                });
                prevResultBtn.disabled = closestIndex <= 0;
                nextResultBtn.disabled = closestIndex >= sections.length - 1;
            } else {
                prevResultBtn.disabled = currentVisibleIndex <= 0;
                nextResultBtn.disabled = currentVisibleIndex >= sections.length - 1;
            }
        }

        function handleNavClick(direction) {
            const sections = document.querySelectorAll('.result-item');
            if (sections.length === 0 || currentVisibleIndex === -1) return;

            let targetIndex;
            if (direction === 'prev') {
                targetIndex = Math.max(0, currentVisibleIndex - 1);
            } else { // 'next'
                targetIndex = Math.min(sections.length - 1, currentVisibleIndex + 1);
            }
            sections[targetIndex]?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem('aiCritiqueAppApiKey');
            if (savedApiKey) {
                updateState({ apiKey: savedApiKey });
            }

            apiKeyInput.addEventListener('input', (e) => {
                updateState({ apiKey: e.target.value });
                localStorage.setItem('aiCritiqueAppApiKey', e.target.value);
            });
            promptInput.addEventListener('input', (e) => {
                if (state.results.length > 0) {
                    updateState({ prompt: e.target.value, results: [], error: null });
                } else {
                    updateState({ prompt: e.target.value });
                }
            });
            generateBtn.addEventListener('click', handleGenerate);

            sharePromptBtn.addEventListener('click', (e) => {
                shareText(state.prompt, e.currentTarget);
            });

            resultsContainer.addEventListener('click', (e) => {
                const shareButton = e.target.closest('.share-btn');
                if (shareButton) {
                    const contentType = shareButton.dataset.contentType;
                    const index = parseInt(shareButton.dataset.index, 10);
                    const textToShare = state.results[index][contentType];
                    shareText(textToShare, shareButton);
                }
            });

            // Modal event listeners
            aboutBtn.addEventListener('click', showModal);
            closeModalBtn.addEventListener('click', hideModal);
            closeModalBtn2.addEventListener('click', hideModal);
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) {
                    hideModal();
                }
            });

            // Floating Navigation event listeners
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300 && state.results.length > 0) {
                    navButtonGroup.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
                    updateNavButtonsState(); // Update button states on scroll
                } else {
                    navButtonGroup.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
                }
            });
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            prevResultBtn.addEventListener('click', () => handleNavClick('prev'));
            nextResultBtn.addEventListener('click', () => handleNavClick('next'));

            // Initial render with default state
            render();
        });
    </script>
</body>

</html>